<!DOCTYPE html>
<html>
  <head>
    <title>Auth Fix Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
      }
      .btn-danger {
        background-color: #dc3545;
        color: white;
      }
      #output {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”§ Crys Garage - Authentication Fix Test</h1>

    <div class="test-section info">
      <h3>ğŸ“‹ Instructions</h3>
      <p>
        This page will test the authentication fix automatically. Follow these
        steps:
      </p>
      <ol>
        <li>Click "Test Authentication" to verify the backend is working</li>
        <li>Click "Test Upload" to test the upload functionality</li>
        <li>Check the output below for results</li>
      </ol>
    </div>

    <div class="test-section">
      <h3>ğŸ§ª Test Controls</h3>
      <button class="btn-primary" onclick="testAuth()">
        Test Authentication
      </button>
      <button class="btn-success" onclick="testUpload()">Test Upload</button>
      <button class="btn-danger" onclick="clearToken()">Clear Token</button>
      <button onclick="checkToken()">Check Token Status</button>
    </div>

    <div id="output"></div>

    <script>
      const API_BASE_URL = "http://localhost:8000/api";

      function log(message, type = "info") {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        const color =
          type === "error" ? "red" : type === "success" ? "green" : "blue";
        output.innerHTML += `<p style="color: ${color}; margin: 5px 0;"><strong>[${timestamp}]</strong> ${message}</p>`;
        output.scrollTop = output.scrollHeight;
      }

      async function testAuth() {
        log("ğŸ” Testing authentication...");

        try {
          // Step 1: Sign in
          log("ğŸ“ Attempting to sign in...");
          const signInResponse = await fetch(`${API_BASE_URL}/auth/signin`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
              email: "test@example.com",
              password: "password123",
            }),
          });

          if (!signInResponse.ok) {
            throw new Error(`Sign in failed: ${signInResponse.status}`);
          }

          const signInData = await signInResponse.json();
          log("âœ… Sign in successful!", "success");
          log(
            `ğŸ‘¤ User: ${signInData.user.name} (${signInData.user.email})`,
            "success"
          );
          log(`ğŸ« Token: ${signInData.token.substring(0, 20)}...`, "success");

          // Store token
          localStorage.setItem("crysgarage_token", signInData.token);

          // Step 2: Test user endpoint
          log("ğŸ” Testing user endpoint...");
          const userResponse = await fetch(`${API_BASE_URL}/user`, {
            headers: {
              Authorization: `Bearer ${signInData.token}`,
              "Content-Type": "application/json",
            },
          });

          if (!userResponse.ok) {
            throw new Error(`User endpoint failed: ${userResponse.status}`);
          }

          const userData = await userResponse.json();
          log("âœ… User endpoint working!", "success");
          log(`ğŸ’° Credits: ${userData.credits}`, "success");
          log(`ğŸ·ï¸ Tier: ${userData.tier}`, "success");
        } catch (error) {
          log(`âŒ Authentication test failed: ${error.message}`, "error");
        }
      }

      async function testUpload() {
        log("ğŸ“¤ Testing upload functionality...");

        try {
          const token = localStorage.getItem("crysgarage_token");
          if (!token) {
            log(
              "âŒ No token found. Please test authentication first.",
              "error"
            );
            return;
          }

          // Create a test audio file
          const testData = new Uint8Array(1000);
          const testFile = new File([testData], "test_audio.wav", {
            type: "audio/wav",
          });

          const formData = new FormData();
          formData.append("audio", testFile);
          formData.append("genre", "afrobeats");

          log("ğŸ“ Creating test file...");
          log("ğŸ“¤ Uploading to server...");

          const uploadResponse = await fetch(`${API_BASE_URL}/upload`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          if (!uploadResponse.ok) {
            const errorData = await uploadResponse.json();
            throw new Error(
              `Upload failed: ${uploadResponse.status} - ${
                errorData.message || "Unknown error"
              }`
            );
          }

          const uploadData = await uploadResponse.json();
          log("âœ… Upload successful!", "success");
          log(`ğŸµ Audio ID: ${uploadData.audio_id}`, "success");

          // Test status endpoint
          log("ğŸ“Š Testing status endpoint...");
          const statusResponse = await fetch(
            `${API_BASE_URL}/status/${uploadData.audio_id}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (statusResponse.ok) {
            const statusData = await statusResponse.json();
            log("âœ… Status endpoint working!", "success");
            log(`ğŸ“ˆ Progress: ${statusData.progress}%`, "success");
            log(`ğŸ“Š Status: ${statusData.status}`, "success");
          }
        } catch (error) {
          log(`âŒ Upload test failed: ${error.message}`, "error");
        }
      }

      function clearToken() {
        localStorage.removeItem("crysgarage_token");
        log("ğŸ—‘ï¸ Token cleared from localStorage", "info");
      }

      function checkToken() {
        const token = localStorage.getItem("crysgarage_token");
        if (token) {
          log("âœ… Token found in localStorage", "success");
          log(`ğŸ« Token: ${token.substring(0, 20)}...`, "info");
        } else {
          log("âŒ No token found in localStorage", "error");
        }
      }

      // Auto-run tests when page loads
      window.onload = function () {
        log("ğŸš€ Auth Fix Test Page Loaded", "success");
        log("ğŸ“ Backend URL: http://localhost:8000", "info");
        log("ğŸ“ Frontend URL: http://localhost:5173", "info");
        log("â³ Ready to test authentication...", "info");
      };
    </script>
  </body>
</html>
