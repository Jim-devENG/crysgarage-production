name: Deploy Frontend and Backend to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: crysgarage-frontend/package-lock.json

      - name: Install dependencies
        working-directory: crysgarage-frontend
        run: npm ci --no-audit --no-fund

      - name: Build frontend
        working-directory: crysgarage-frontend
        run: npm run build

      - name: Write deployment version file
        run: |
          echo "commit_sha=${{ github.sha }}" > frontend_version.txt
          echo "ref_name=${GITHUB_REF_NAME:-unknown}" >> frontend_version.txt
          echo "deployed_at=$(date -u +%FT%TZ)" >> frontend_version.txt

      - name: Upload build to VPS (/var/www/frontend_publish)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "crysgarage-frontend/dist/*"
          target: "/var/www/frontend_publish/"
          overwrite: true
          strip_components: 1

      - name: Upload version file to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "frontend_version.txt"
          target: "/var/www/frontend_publish/"
          overwrite: true

      - name: Rebuild and restart backend (current setup)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            COMPOSE_FILE=/var/www/crysgarage/docker-compose-simple.yml
            if [ -f "$COMPOSE_FILE" ]; then
              # Ensure compose exists and rebuild backend image from current server context
              docker-compose -f "$COMPOSE_FILE" build backend || true
              docker-compose -f "$COMPOSE_FILE" up -d backend
            else
              echo "docker-compose-simple.yml not found; skipping backend build"
            fi

      - name: Restart Nginx container (current setup)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            COMPOSE_FILE=/var/www/crysgarage/docker-compose-simple.yml
            if [ -f "$COMPOSE_FILE" ]; then
              docker-compose -f "$COMPOSE_FILE" ps || true
              docker-compose -f "$COMPOSE_FILE" restart nginx || \
              (docker-compose -f "$COMPOSE_FILE" up -d nginx)
            else
              echo "docker-compose-simple.yml not found; attempting container restart by name"
              docker ps --format '{{.Names}}' | grep -q '^crysgarage-nginx' && docker restart $(docker ps --format '{{.Names}}' | grep '^crysgarage-nginx') || true
            fi

      - name: Verify homepage and API
        run: |
          curl -fsS https://crysgarage.studio/ | head -n 20
          curl -fsSI https://crysgarage.studio/api/ || true

      - name: Verify deployed version on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            echo "--- /var/www/frontend_publish/version.txt ---"
            cat /var/www/frontend_publish/version.txt || echo "version.txt not found"